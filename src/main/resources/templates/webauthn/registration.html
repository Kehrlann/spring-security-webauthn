<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>WebAuthn - Registration</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <link href="https://getbootstrap.com/docs/4.0/examples/signin/signin.css" rel="stylesheet" crossorigin="anonymous"/>
    <meta name="webAuthnChallenge" th:content="${webAuthnChallenge}" content="" />
    <script
            src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
            crossorigin="anonymous"></script>
    <script th:src="@{/base64url.js}"></script>
    <script type="text/javascript">
        if (!window.PublicKeyCredential) { /* Client not capable. Handle error. */ }

        function register() {
            var challenge = $("meta[name=webAuthnChallenge]").attr("content");
            var publicKey = {
                // The challenge is produced by the server; see the Security Considerations
                challenge: base64url.decodeBase64url(challenge),

                // Relying Party:
                rp: {
                    name: "ACME Corporation"
                },

                // User:
                user: {
                    id: Uint8Array.from(window.atob("MIIBkzCCATigAwIBAjCCAZMwggE4oAMCAQIwggGTMII="), c => c.charCodeAt(0)),
                    name: "alex.p.mueller@example.com",
                    displayName: "Alex P. MÃ¼ller",
                },

                // This Relying Party will accept either an ES256 or RS256 credential, but
                // prefers an ES256 credential.
                pubKeyCredParams: [
                    {
                        type: "public-key",
                        alg: -7 // "ES256" as registered in the IANA COSE Algorithms registry
                    },
                    {
                        type: "public-key",
                        alg: -257 // Value registered by this specification for "RS256"
                    }
                ],

                authenticatorSelection: {
                    // Try to use UV if possible. This is also the default.
                    userVerification: "preferred"
                },

                timeout: 360000,  // 6 minutes
                excludeCredentials: [], // No exclude list of PKCredDescriptors
                extensions: {"loc": true}  // Include location information
                // in attestation
            };

            // Note: The following call will cause the authenticator to display UI.
            return navigator.credentials.create({publicKey})
                .then(function (credential) {
                    console.log('Created credentials ' + credential);
                    $('#clientDataJSON').val(base64url.encodeBase64url(credential.response.clientDataJSON));
                    $('#attestationObject').val(base64url.encodeBase64url(credential.response.attestationObject));
                    $('#clientExtensions').val(JSON.stringify(credential.getClientExtensionResults()));
                    console.log("Updated the hidden inputs");
                }).catch(function (e) {
                    console.error("Error:%s, Message:%s", e.name, e.message);
                });
        }
        $(document).ready(function() {
            $("#register").submit(function(e) {
                var f = this;
                register().then(r => f.submit());
                return false;
            });
        });
    </script>
</head>
<body>
<div class="container">
    <form id="register" class="form-signin" method="post" th:action="@{/webauthn/register}">
        <h2 class="form-signin-heading">WebAuthn - Registration</h2>
        <button class="btn btn-lg btn-primary btn-block" type="submit">Register</button>
        <input type="hidden" id="clientDataJSON" name="clientDataJSON">
        <input type="hidden" id="attestationObject" name="attestationObject">
        <input type="hidden" id="clientExtensions" name="clientExtensions">
    </form>
</div>
</body></html>